<!doctype html>
<meta charset=utf-8>
<title>Bases</title>
<script src="http://static.opentok.com/v1.1/js/TB.min.js"></script>
<script>
  // The API key identifies you as a developer registered to use the OpenTok API.
  // While testing out the basic tutorial application, you can use the sample code API key (1127).
  var apiKey = "1127"; // "22064792";

  // The session ID is a unique identifier for your OpenTok video chat session.
  var sessionId = "2_MX4yMjA2NDc5Mn4xMjcuMC4wLjF-U2F0IERlYyAyMiAwMDo0MDo1NCBQU1QgMjAxMn4wLjcxMTU3MzM2fg";

  // The token string identifies a user. It is used to validate a participant. (moderator role)
  var token = 'T1==cGFydG5lcl9pZD0yMjA2NDc5MiZzaWc9YzkyMmNkNDIwZmE5NTZmNjU0OTQ2YmNkMDgzZTQ5YmNkZDc4MjdiMjpzZXNzaW9uX2lkPTJfTVg0eU1qQTJORGM1TW40eE1qY3VNQzR3TGpGLVUyRjBJRVJsWXlBeU1pQXdNRG8wTURvMU5DQlFVMVFnTWpBeE1uNHdMamN4TVRVM016TTJmZyZjcmVhdGVfdGltZT0xMzU2MTY1Njc2JmV4cGlyZV90aW1lPTEzNTg3NTc2NzYmcm9sZT1tb2RlcmF0b3ImY29ubmVjdGlvbl9kYXRhPSZub25jZT0yMTQ0MDQ=';
  
  // Session object
  var session;
  
  // Publisher (me) object
  var publisher;
  
  // Subscribers (others) list
  var subscribers = {};
  
  // Video size constants
  var VIDEO_WIDTH = 320;
  var VIDEO_HEIGHT = 240;

  // Alert if an error occurs
  TB.addEventListener("exception", exceptionHandler);
  function exceptionHandler(event) {
    alert("Exception: " + event.code + "::" + event.message);
  }

  // Check flash
  if (TB.checkSystemRequirements() != TB.HAS_REQUIREMENTS) {
    alert("You don't have the minimum requirements to run this application."
        + "Please upgrade to the latest version of Flash.");
  }
  
  // Initialize session
  else {
    session = TB.initSession(sessionId);

    // Add event listeners to the session (functions to call when an event occurs)
    session.addEventListener('sessionConnected', sessionConnectedHandler);
    session.addEventListener('sessionDisconnected', sessionDisconnectedHandler);
    session.addEventListener('connectionCreated', connectionCreatedHandler);
    session.addEventListener('connectionDestroyed', connectionDestroyedHandler);
    session.addEventListener('streamCreated', streamCreatedHandler);
    session.addEventListener('streamDestroyed', streamDestroyedHandler);
  }

  // Connect button
  function connect() {
    session.connect(apiKey, token);
  }

  // Disconnect button
  function disconnect() {
    session.disconnect();
    hide('disconnectLink');
    hide('publishLink');
    hide('unpublishLink');
  }

  // Publish button (show my webcam)
  function startPublishing() {
    if (!publisher) {
      var parentDiv = document.getElementById("myCamera");
      var publisherDiv = document.createElement('div');
      publisherDiv.setAttribute('id', 'opentok_publisher');
      parentDiv.appendChild(publisherDiv);
      var publisherProps = {width: VIDEO_WIDTH, height: VIDEO_HEIGHT};
      publisher = TB.initPublisher(apiKey, publisherDiv.id, publisherProps);
      session.publish(publisher);
      show('unpublishLink');
      hide('publishLink');
    }
  }

  // Stop publish button
  function stopPublishing() {
    if (publisher) {
      session.unpublish(publisher);
    }
    publisher = null;

    show('publishLink');
    hide('unpublishLink');
  }

  // When I am connected, watch all streams currently in the session
  function sessionConnectedHandler(event) {
    for (var i = 0; i < event.streams.length; i++) {
      addStream(event.streams[i]);
    }
    show('disconnectLink');
    show('publishLink');
    hide('connectLink');
  }

  // When I start my stream, publish it to other people
  // Also, when other streams are created, watch them and publish to them
  function streamCreatedHandler(event) {
    for (var i = 0; i < event.streams.length; i++) {
      addStream(event.streams[i]);
    }
  }

  // addStream
  function addStream(stream) {
    // Don't publish for myself
    if (stream.connection.connectionId == session.connection.connectionId) {
      return;
    }
    var subscriberDiv = document.createElement('div');
    subscriberDiv.setAttribute('id', stream.streamId);
    document.getElementById("subscribers").appendChild(subscriberDiv);
    var subscriberProps = {width: VIDEO_WIDTH, height: VIDEO_HEIGHT};
    subscribers[stream.streamId] = session.subscribe(stream, subscriberDiv.id, subscriberProps);
  }

  // When a stream is stopped
  function streamDestroyedHandler(event) {
    // Everybody stops to see it automatically.
  }

  // When a person disconnects
  function sessionDisconnectedHandler(event) {
    // Everybody stops to see him connected automatically.
    publisher = null;
    show('connectLink');
    hide('disconnectLink');
    hide('publishLink');
    hide('unpublishLink');
  }

  // Connection start
  function connectionCreatedHandler(event) {
    // Nothing mandatory
  }
  
  // Connection end
  function connectionDestroyedHandler(event){
    // Nothing mandatory
  }

  // Show (a button)
  function show(id) {
    document.getElementById(id).style.display = 'block';
  }

  // Hide (a button)
  function hide(id) {
    document.getElementById(id).style.display = 'none';
  }
</script>
<div id="opentok_console"></div>
<div id="links">
  <input type="button" value="Connect" id ="connectLink" onClick="javascript:connect()" />
  <input type="button" value="Leave" id ="disconnectLink" onClick="javascript:disconnect()" style="display: none"/>
  <input type="button" value="Start Publishing" id ="publishLink" onClick="javascript:startPublishing()" style="display: none"/>
  <input type="button" value="Stop Publishing" id ="unpublishLink" onClick="javascript:stopPublishing()" style="display: none"/>
</div>
<div id="myCamera" class="publisherContainer"></div>
<div id="subscribers"></div>
